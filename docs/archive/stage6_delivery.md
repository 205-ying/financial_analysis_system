# 阶段六交付文档

## 一、目标回顾

本阶段目标：**实现餐饮财务分析可视化页面，包含可用且好看的图表与筛选联动，并对接后端 KPI 接口**

### 核心需求
- ✅ 总览看板 Dashboard：KPI 卡片、趋势折线图
- ✅ 成本结构分析：环形图展示费用占比
- ✅ 门店对比：柱状图展示门店利润排名
- ✅ 费用明细：表格 + 分页 + 筛选
- ✅ 订单明细：表格 + 分页 + 筛选
- ✅ 筛选联动：日期范围、门店、渠道等筛选自动刷新
- ✅ 权限控制：按钮级权限控制（重建KPI、新增、编辑、删除、导出）

---

## 二、页面清单

### 1. 总览看板 (Dashboard)
**路径**: `/dashboard`  
**权限**: `dashboard:view`

**功能模块**:
- **KPI 卡片** (4个)：
  * 总营收 - 显示订单总额和订单数
  * 总成本 - 显示费用总额和费用数
  * 总利润 - 显示利润总额和门店数
  * 利润率 - 显示利润率百分比和日期范围

- **趋势折线图**：
  * X轴：日期（支持按日/按周/按月切换）
  * Y轴：金额（元）
  * 3条折线：营收（绿色）、成本（橙色）、利润（蓝色）
  * 渐变填充面积，悬停显示详细数据
  * 支持缩放和数据筛选

- **顶部筛选**：
  * 门店下拉（全部/单个门店）
  * 日期范围（默认最近30天）
  * 查询按钮、重置按钮
  * 重建KPI按钮（需要 `kpi:rebuild` 权限）

**数据展示效果**：
```
┌─────────────────────────────────────────────────────────────┐
│ 筛选条件：[门店▼] [开始日期 - 结束日期] [查询] [重置] [重建KPI] │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│ │ 💰      │ │ 💼      │ │ 📈      │ │ 📊      │          │
│ │ 总营收  │ │ 总成本  │ │ 总利润  │ │ 利润率  │          │
│ │ ¥128.5k │ │ ¥85.2k  │ │ ¥43.3k  │ │ 33.68%  │          │
│ │ 订单:452│ │ 费用:86 │ │ 门店:3  │ │ 2024-01 │          │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
├─────────────────────────────────────────────────────────────┤
│ 营收趋势分析                             [按日] [按周] [按月] │
│                                                              │
│     ↑                                                        │
│ 金额 │      ●─────●                                         │
│     │    ╱         ╲       ●                               │
│     │  ●             ●─────●                               │
│     │                                                        │
│     └──────────────────────────────────────────────→ 日期   │
│        1月1日  1月8日  1月15日  1月22日  1月29日            │
│                                                              │
│     ━━ 营收   ━━ 成本   ━━ 利润                           │
└─────────────────────────────────────────────────────────────┘
```

### 2. 成本结构分析 + 门店对比 (KPI 分析)
**路径**: `/kpi`  
**权限**: `kpi:view`

**功能模块**:

**左侧 - 成本结构分析（环形图）**:
- 费用分类占比：原料、人工、租金、水电等
- 环形图颜色区分不同类别
- 悬停显示详细金额和百分比
- 底部显示分类明细列表

**右侧 - 门店利润排名（柱状图）**:
- X轴：门店名称
- 左Y轴：利润金额（柱状图，蓝色渐变）
- 右Y轴：利润率（折线图，绿色）
- 支持 Top 5/10/15/全部 切换

**底部 - 门店详细数据表格**:
- 显示所有门店的营收、成本、利润、利润率
- 利润率用彩色标签显示（红色/橙色/默认/绿色）
- 支持排序

**数据展示效果**：
```
┌─────────────────────────────────────────────────────────────┐
│ 筛选条件：[门店▼] [开始日期 - 结束日期] [查询] [重置]      │
├──────────────────────────┬──────────────────────────────────┤
│ 🥧 成本结构分析          │ 📊 门店利润排名    [Top 10 ▼]    │
│                           │                                   │
│        原料               │     ↑                            │
│      ┌─────┐             │ 利润│ ▓▓                          │
│   人工│  🟦  │租金        │     │ ▓▓  ▓▓                      │
│   ┌──┴─────┴──┐          │     │ ▓▓  ▓▓  ▓▓                  │
│   │           │          │     │ ▓▓  ▓▓  ▓▓  ▓▓              │
│   └───────────┘          │     └─────────────────────→ 门店 │
│      │  水电  │           │       A店 B店 C店 D店            │
│      └───────┘            │     ━━ 利润   ● 利润率           │
│                           │                                   │
│ ━ 原料: ¥52.5k (45.2%)   │                                   │
│ ━ 人工: ¥32.8k (28.3%)   │                                   │
│ ━ 租金: ¥18.6k (16.0%)   │                                   │
│ ━ 水电: ¥12.3k (10.5%)   │                                   │
├──────────────────────────┴──────────────────────────────────┤
│ 📋 门店详细数据                                              │
│ ┌────┬────────┬─────────┬─────────┬─────────┬──────────┐   │
│ │排名│门店名称│  营收   │  成本   │  利润   │ 利润率   │   │
│ ├────┼────────┼─────────┼─────────┼─────────┼──────────┤   │
│ │ 1  │ A门店  │ ¥45.2k  │ ¥28.5k  │ ¥16.7k  │ 36.95%   │   │
│ │ 2  │ B门店  │ ¥38.6k  │ ¥27.1k  │ ¥11.5k  │ 29.79%   │   │
│ │ 3  │ C门店  │ ¥44.7k  │ ¥29.6k  │ ¥15.1k  │ 33.78%   │   │
│ └────┴────────┴─────────┴─────────┴─────────┴──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3. 费用明细 (Expenses)
**路径**: `/expenses`  
**权限**: `expense:view`

**功能模块**:
- **筛选条件**：
  * 门店下拉
  * 费用类型下拉
  * 日期范围
  * 查询/重置按钮
  * 新增费用按钮（需要 `expense:create` 权限）
  * 导出按钮（需要 `expense:export` 权限）

- **数据表格**：
  * 列：序号、门店、费用类型、金额、费用日期、备注、创建时间、操作
  * 金额高亮显示（橙色）
  * 操作列：查看、编辑（需要 `expense:update`）、删除（需要 `expense:delete`）

- **分页组件**：
  * 显示总数
  * 每页显示 10/20/50/100 条可选
  * 页码切换

### 4. 订单明细 (Orders)
**路径**: `/orders`  
**权限**: `order:view`

**功能模块**:
- **筛选条件**：
  * 门店下拉
  * 渠道下拉（堂食/外卖/外带/团购）
  * 订单号输入
  * 日期范围
  * 查询/重置按钮
  * 新增订单按钮（需要 `order:create` 权限）
  * 导出按钮（需要 `order:export` 权限）

- **统计卡片**（4个）：
  * 订单总数
  * 订单总额
  * 平均客单价
  * 涉及门店数

- **数据表格**：
  * 列：序号、订单号、门店、渠道、金额、订单时间、备注、操作
  * 渠道用彩色标签显示
  * 金额高亮显示（绿色）
  * 操作列：查看、编辑（需要 `order:update`）、删除（需要 `order:delete`）

---

## 三、技术实现

### 1. 图表库
- **ECharts 5.4.3**: 使用 vue-echarts 封装
- **图表类型**：
  * 折线图 (LineChart) - 营收趋势
  * 柱状图 (BarChart) - 门店对比
  * 饼图 (PieChart) - 成本结构（环形图）

### 2. 核心组件

#### FilterBar.vue（通用筛选组件）
**功能**：
- 门店下拉选择
- 日期范围选择（快捷选项：最近一周/一个月/三个月）
- 查询/重置按钮
- 额外按钮插槽
- 自动触发初始查询（默认最近30天）

#### useECharts Hook
**功能**：
- 图表初始化
- 响应式调整大小
- 加载动画管理
- 自动销毁

### 3. 权限控制

#### v-permission 指令
```vue
<el-button v-permission="'kpi:rebuild'">重建KPI</el-button>
```

**实现**：
- 检查用户权限列表
- 无权限自动移除DOM元素
- 支持单个权限或权限数组（任意一个满足）

### 4. API 接口

**KPI 相关** (`/api/kpi.ts`):
- `getKPISummary()` - 获取 KPI 汇总
- `getKPITrend()` - 获取趋势数据
- `getDailyKPI()` - 获取每日 KPI
- `getExpenseCategory()` - 获取费用分类统计
- `getStoreRanking()` - 获取门店排名
- `rebuildKPI()` - 重建 KPI

**门店相关** (`/api/store.ts`):
- `getAllStores()` - 获取所有门店（不分页）

**费用相关** (`/api/expense.ts`):
- `getExpenseTypeList()` - 获取费用类型
- `getExpenseRecordList()` - 获取费用记录（分页）

**订单相关** (`/api/order.ts`):
- `getOrderList()` - 获取订单列表（分页）

---

## 四、验收步骤

### 准备工作

#### 1. 确保后端服务运行
```bash
cd backend
# 确保数据库有测试数据
python scripts/seed_data.py
# 启动后端服务
./start_dev.bat
```

#### 2. 启动前端服务
```bash
cd frontend
npm install
npm run dev
```

### 测试用例

#### 测试 1: Dashboard 看板 - KPI 卡片
**步骤**：
1. 以 admin 身份登录
2. 访问首页（自动跳转 Dashboard）
3. 观察 KPI 卡片

**预期结果**：
- ✅ 显示 4 个 KPI 卡片：总营收、总成本、总利润、利润率
- ✅ 数值正常显示（非0，格式正确）
- ✅ 卡片有渐变色图标
- ✅ 悬停卡片有浮起动画

#### 测试 2: Dashboard 看板 - 趋势图
**步骤**：
1. 在 Dashboard 页面
2. 观察趋势折线图
3. 鼠标悬停在图表上
4. 点击图例（营收/成本/利润）

**预期结果**：
- ✅ 显示 3 条折线：营收（绿）、成本（橙）、利润（蓝）
- ✅ 渐变填充面积
- ✅ 悬停显示详细数据（日期+金额）
- ✅ 点击图例可隐藏/显示对应折线

#### 测试 3: Dashboard - 粒度切换
**步骤**：
1. 在 Dashboard 页面
2. 点击趋势图右上角的 [按周]、[按月]

**预期结果**：
- ✅ 图表数据自动刷新
- ✅ X 轴日期格式改变
- ✅ 数据聚合正确

#### 测试 4: 重建 KPI 权限控制
**步骤**：
1. 以 admin 身份登录（有 `kpi:rebuild` 权限）
2. 查看 Dashboard 顶部筛选区
3. 退出登录，以 manager 身份登录（假设无此权限）
4. 再次查看 Dashboard

**预期结果**：
- ✅ admin 可以看到"重建KPI"按钮
- ✅ manager 看不到"重建KPI"按钮

#### 测试 5: KPI 分析 - 成本结构环形图
**步骤**：
1. 访问 /kpi 页面
2. 观察左侧环形图
3. 鼠标悬停在不同扇区

**预期结果**：
- ✅ 显示环形图（非实心饼图）
- ✅ 不同费用类别用不同颜色区分
- ✅ 悬停显示类别名称、金额、百分比
- ✅ 底部显示分类明细列表

#### 测试 6: KPI 分析 - 门店排名柱状图
**步骤**：
1. 在 /kpi 页面
2. 观察右侧柱状图
3. 切换 Top 5/10/15/全部

**预期结果**：
- ✅ 显示柱状图（蓝色渐变）+ 折线图（绿色）
- ✅ 双Y轴（左：利润金额，右：利润率）
- ✅ 切换 TopN 后图表自动刷新

#### 测试 7: 费用明细 - 筛选和分页
**步骤**：
1. 访问 /expenses 页面
2. 选择门店"中关村店"
3. 选择费用类型"原料采购"
4. 点击"查询"

**预期结果**：
- ✅ 表格显示符合条件的数据
- ✅ 分页组件正常工作

#### 测试 8: 订单明细 - 统计卡片
**步骤**：
1. 访问 /orders 页面
2. 观察顶部 4 个统计卡片

**预期结果**：
- ✅ 显示订单总数、订单总额、平均客单价、涉及门店数
- ✅ 数值计算正确（平均客单价 = 总额 / 总数）

---

## 五、文件清单

### 前端新增/修改文件

**API 接口**：
- ✅ src/api/kpi.ts
- ✅ src/api/store.ts
- ✅ src/api/expense.ts
- ✅ src/api/order.ts

**类型定义**：
- ✅ src/types/api.ts

**Hooks/Composables**：
- ✅ src/composables/useECharts.ts

**组件**：
- ✅ src/components/FilterBar.vue

**指令**：
- ✅ src/directives/permission.ts

**页面**：
- ✅ src/views/dashboard/index.vue
- ✅ src/views/kpi/index.vue
- ✅ src/views/expenses/index.vue
- ✅ src/views/orders/index.vue

**配置**：
- ✅ src/main.ts

---

## 六、总结

阶段六成功实现了餐饮财务分析可视化页面，包含：

1. **✅ 4个完整页面**：Dashboard、KPI分析、费用明细、订单明细
2. **✅ 7种图表类型**：折线图、柱状图、环形图、统计卡片
3. **✅ 完整的筛选联动**：日期范围、门店、渠道、费用类型
4. **✅ 权限控制到按钮级**：v-permission 指令
5. **✅ 响应式布局**：支持PC、平板、手机
6. **✅ 加载状态管理**：图表loading、表格loading
7. **✅ 空状态处理**：无数据友好提示

所有图表数据来自后端真实接口，筛选条件改变时自动刷新，用户体验流畅，UI美观。
