# 阶段六快速测试指南

## 环境准备

### 1. 后端服务
```bash
cd backend
python scripts/seed_data.py  # 生成测试数据
./start_dev.bat              # Windows
# 或
./start_dev.sh               # Linux/Mac
```

### 2. 前端服务
```bash
cd frontend
npm install
npm run dev
```

访问: http://localhost:5173

---

## 快速验收（10分钟）

### ✅ 测试1：Dashboard 看板（2分钟）
1. 登录 admin / Admin@123
2. 查看 4 个 KPI 卡片（营收、成本、利润、利润率）
3. 查看趋势折线图（3 条线：绿/橙/蓝）
4. 悬停图表查看详细数据
5. 切换粒度：[按日] [按周] [按月]
6. 改变日期范围，点击"查询"，观察数据刷新

**期望**：卡片数值正常，图表显示流畅，筛选联动生效

---

### ✅ 测试2：KPI 分析页面（2分钟）
1. 访问 /kpi
2. 左侧：查看成本结构环形图
   - 悬停不同扇区
   - 底部查看明细列表
3. 右侧：查看门店排名柱状图
   - 切换 Top 5/10/15
   - 观察双 Y 轴（利润+利润率）
4. 底部：查看门店详细表格
   - 观察利润率标签颜色

**期望**：环形图显示费用占比，柱状图显示门店排名，表格数据完整

---

### ✅ 测试3：费用明细（2分钟）
1. 访问 /expenses
2. 筛选：选择门店、费用类型、日期范围
3. 点击"查询"
4. 查看表格数据
5. 切换每页显示数量
6. 观察"新增费用"、"导出"、"编辑"、"删除"按钮

**期望**：表格显示费用数据，分页正常，权限按钮显示正确

---

### ✅ 测试4：订单明细（2分钟）
1. 访问 /orders
2. 查看顶部 4 个统计卡片
3. 筛选：选择门店、渠道、日期范围
4. 点击"查询"
5. 查看表格数据（渠道标签颜色）
6. 切换分页

**期望**：统计卡片计算正确，渠道标签有颜色，表格分页正常

---

### ✅ 测试5：权限控制（2分钟）
1. 以 admin 登录
2. 查看 Dashboard 是否有"重建KPI"按钮
3. 查看 /expenses 是否有"新增"、"编辑"、"删除"按钮
4. 退出，以 manager 登录（如果有）
5. 再次查看相同页面

**期望**：admin 有全部按钮，manager 权限受限（按钮隐藏）

---

## 常见问题排查

### 问题1：图表不显示
**原因**：可能后端接口未启动或数据库无数据
**解决**：
```bash
cd backend
python scripts/seed_data.py
./start_dev.bat
```

### 问题2：筛选后无数据
**原因**：选择的日期范围内确实无数据
**解决**：重置筛选条件，或查看测试数据的日期范围

### 问题3：按钮权限控制失效
**原因**：用户权限未正确配置
**解决**：检查后端返回的 permissions 数组

### 问题4：图表显示异常
**原因**：浏览器兼容性或 echarts 加载失败
**解决**：
- 清除浏览器缓存
- 检查浏览器控制台错误
- 使用 Chrome 最新版

---

## 页面截图说明（文字描述）

### Dashboard 看板
```
顶部：筛选区（门店下拉、日期范围、查询、重置、重建KPI）
中部：4个KPI卡片横排，每个卡片有图标、标题、数值、副标题
      卡片颜色：营收(绿)、成本(橙)、利润(蓝)、利润率(红)
下部：趋势折线图，3条线带渐变填充，右上角粒度切换按钮
```

### KPI 分析
```
顶部：筛选区
左半：成本结构环形图 + 底部明细列表（类别、金额、百分比）
右半：门店排名柱状图 + TopN选择器
底部：门店详细表格（排名、门店名称、营收、成本、利润、利润率）
```

### 费用明细
```
顶部：筛选区（门店、费用类型、日期范围）+ 操作按钮（新增、导出）
中部：数据表格（序号、门店、费用类型、金额、日期、备注、操作）
      金额橙色高亮，操作列有查看/编辑/删除按钮
底部：分页组件（总数、每页数量、页码）
```

### 订单明细
```
顶部：筛选区（门店、渠道、订单号、日期范围）+ 操作按钮
次级：4个统计卡片（订单总数、总额、客单价、门店数）
中部：数据表格（序号、订单号、门店、渠道标签、金额、时间、操作）
      金额绿色高亮，渠道有彩色标签
底部：分页组件
```

---

## 数据流说明

```
用户操作筛选条件（门店/日期/渠道等）
  ↓
点击"查询"按钮
  ↓
触发 @query 事件，传递筛选参数
  ↓
页面组件调用 API 接口（getKPISummary/getKPITrend等）
  ↓
显示 loading 状态（图表loading动画/表格遮罩）
  ↓
接收后端 JSON 数据
  ↓
数据处理和格式化
  ↓
渲染图表（ECharts setOption）或更新表格
  ↓
隐藏 loading，展示结果
```

---

## 关键组件说明

### FilterBar.vue
- **作用**：统一的筛选组件，各页面复用
- **功能**：门店选择、日期范围、查询/重置
- **特点**：自动触发初始查询，支持额外按钮插槽

### useECharts Hook
- **作用**：封装 ECharts 通用逻辑
- **功能**：初始化、设置配置、loading管理、自动销毁
- **特点**：响应式调整大小，自动监听窗口变化

### v-permission 指令
- **作用**：按钮级权限控制
- **功能**：根据用户权限显示/隐藏元素
- **用法**：`v-permission="'kpi:rebuild'"`

---

## 验收通过标准

✅ **必须通过（5项）**：
1. Dashboard 显示 KPI 卡片和趋势图，数据正常
2. KPI 分析显示环形图和柱状图，数据正常
3. 费用明细和订单明细表格有数据，分页正常
4. 筛选条件改变后数据自动刷新
5. 权限按钮显示正确（admin 有权限，manager 受限）

✅ **建议通过（3项）**：
1. 图表交互流畅（悬停、点击图例）
2. 响应式布局适配（缩小窗口测试）
3. 加载状态和空状态友好

---

## 交付清单

📁 **前端文件（13个）**：
- 4 个 API 文件：kpi.ts, store.ts, expense.ts, order.ts
- 1 个 Hook：useECharts.ts
- 1 个组件：FilterBar.vue
- 1 个指令：permission.ts
- 4 个页面：dashboard, kpi, expenses, orders
- 2 个修改：types/api.ts, main.ts

📄 **文档（2个）**：
- stage6_delivery.md：完整交付文档
- STAGE6_TEST.md：本测试指南

---

## 下一步

阶段六完成后，可以继续：
1. 实现新增/编辑/删除的弹窗表单
2. 实现导出功能（Excel/PDF）
3. 添加更多图表类型（雷达图、热力图等）
4. 性能优化（虚拟滚动、请求缓存等）
5. 单元测试和E2E测试

---

测试完成后，请在 stage6_delivery.md 文档底部标注验收结果！
